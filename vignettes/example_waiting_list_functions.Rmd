---
title: "Walkthrough of waiting list functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Walkthrough a real waiting list example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(NHSRwaitinglist)
library(ggplot2)

# set a seed so that these plots are always the same
set.seed(2)
```

This vignette is a worked example using a sample dataset similar to that which you may be working with.

In it's purest form, a waiting list consists of the dates that individuals arrived in a queue, and the dates that they left having been seen by the service (doctor, nurse, or diagnostic test, etc).  These dates are the are waiting list additions or arrivals, and waiting list removals.  They correspond to demand (for arrivals), and capacity (for removals).

This vignette is going to simulate 3 different waiting lists: 

1. A list where demand is higher than capacity
2. A list where demand and capacity are similar
3. A list where there is sufficient capacity for the demand

## 1. A growing waiting list

So first we need a waiting list, and we can make a synthetic one using the `wl_simulator()` function.  We decide how long our simulation should run for, and what our weekly demand and capacity is.  In the example below the capacity is less than the demand, so over time we should expect a queue to form.  

```{r}
waiting_list <- wl_simulator(
  start_date = "2020-01-01",
  end_date = "2024-03-31",
  demand = 10, # simulating 10 patient arrivals per week
  capacity = 9 # simulating 9 patients being treated per week (removed from the waiting list)
)

head(waiting_list, 10)

```

Now that we have a waiting list, we should visualise it.  We can use the `wl_queue_size()` function to tell us the size of the queue at the end of each day.  We can use ggplot to make a plot of the queue size over time, and as expected it gets larger and larger because our demand is bigger than our capacity.  

```{r}
# calculate the queue size
queue_size <- wl_queue_size(waiting_list)

head(queue_size)

tail(queue_size)

# visualise the queue with a plot
ggplot(queue_size, aes(dates, queue_size)) +
  geom_line()

```

### Referral statistics

Next, we might be interested in some statistics about the referrals, or arrivals, to the queue.  We can use the `wl_referral_stats()` function to calculate these.

```{r}
referral_stats <- wl_referral_stats(waiting_list)

head(referral_stats)
```

Now we can see that `r referral_stats$demand.count` patients joined our simulated waiting list, at an average rate of `r round(referral_stats$demand.weekly, 2)` per week, or `r round(referral_stats$demand.daily, 2)` per day.  Very close to the 10 patients a week we requested when we made our simulated waiting list using `wl_simulator()`.  The final statistic of interest is the coefficient of variation, which is `r round(referral_stats$demand.cov, 2)`.

### Removal statistics

Similarly, we might be interested in some statistics about the removals from the queue.  We can use the `wl_removal_stats()` function to calculate these.

```{r}
removal_stats <- wl_removal_stats(waiting_list)

head(removal_stats)
```

Now we can see that `r removal_stats$removal.count` patients were treated and removed from our simulated waiting list, at an average rate of `r round(removal_stats$capacity.weekly, 2)` per week, or `r round(removal_stats$capacity.daily, 2)` per day.  Very close to the 9 patients a week we set up using `wl_simulator()`.  The final statistic of interest is the coefficient of variation (for removals), which is `r round(removal_stats$capacity.cov, 2)`.

### Overall stats

Finally, we can calculate a combined set of statistics to summarise the waiting list.  To do this we need to provide the target waiting time.  This might be 2 weeks for a cancer referral, or commonly 18 weeks for a standard non-cancer referral.  

```{r}
overall_stats <- wl_stats(
  waiting_list = waiting_list,
  target_wait = 18 # standard NHS 18wk target
)

head(overall_stats)
```

This gives us a lot of useful information.  Taking it step by step:

The first 4 columns tell us whether the load is larger than 1.  If it is, we can expect the queue to continue growing indefinitely.

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(
    mean.demand,
    mean.capacity,
    load,
    load.too.big
  ), 
  align = "c"
)

```

The next columns tell us about the resulting queue size at the end of our simulation, the target size we need to plan for in order to achieve the 18 week waiting target, and a judgement about whether the queue is too large.  If the queue is too large, we need to implement some relief capacity to bring it within range before attempting to maintain the queue. 

```{r, echo=FALSE}
knitr::kable(
  overall_stats|> dplyr::select(
    queue_size,
    target_queue_size,
    queue.too.big,
    mean_wait
  ), 
  align = "c"
)

```

There is a column to report the actual average patient waiting time, which is `r round(overall_stats$mean_wait, 2)` weeks, compared to our target of 18 weeks. 

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(mean_wait), 
  align = "c"
)

```

These two columns re-state the coefficients of variance for use in reporting.

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(
    cv_arrival,
    cv_removal
  ), 
  align = "c"
)
```

The next two columns tell us about the required capacity.  Only one will contain data.

1. If the queue is not too large, "target.capacity" will report the capacity required to maintain the queue at it's target waiting time performance.
2. If the queue is too large, "relief.capacity" will report the capacity required to bring the queue to a maintainable size within 26 weeks (6 months).  

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(target.capacity, relief.capacity), 
  align = "c"
)
```

The final column reports the waiting list "pressure".  This will be useful later when comparing waiting lists of differing sizes, with differing targets.  It allows waiting list pressures to be compared because the waiting list with the largest number of patients waiting is not always the list with the largest problem meeting it's target.  

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(pressure), 
  align = "c"
)
```

## 2. A finely balanced waiting list

This waiting list is finely balanced. Capacity is larger than demand, but not by a wide margin (there is approximately 5% "spare" capacity). 

```{r}
waiting_list <- wl_simulator(
  start_date = "2020-01-01",
  end_date = "2024-03-31",
  demand = 10, # simulating 10 patient arrivals per week
  capacity = 10.2 # simulating 10.2 patients being treated per week
)
```

Now we can visualise the new queue.  
as expected it gets larger and larger because our demand is bigger than our capacity.  

```{r}
# calculate the queue size
queue_size <- wl_queue_size(waiting_list)

# visualise the queue with a plot
ggplot(queue_size, aes(dates, queue_size)) +
  geom_line()

```

This time we will go straight to calculating the overall stats.  

```{r}
overall_stats <- wl_stats(
  waiting_list = waiting_list,
  target_wait = 18 # standard NHS 18wk target
)

head(overall_stats)
```

This gives us a lot of useful information.  Taking it step by step:

The first 4 columns tell us whether the load is larger than 1.  If it is, we can expect the queue to continue growing indefinitely.

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(
    mean.demand,
    mean.capacity,
    load,
    load.too.big
  ), 
  align = "c"
)

```

The next columns tell us about the resulting queue size at the end of our simulation, the target size we need to plan for in order to achieve the 18 week waiting target, and a judgement about whether the queue is too large.  If the queue is too large, we need to implement some relief capacity to bring it within range before attempting to maintain the queue. 

```{r, echo=FALSE}
knitr::kable(
  overall_stats|> dplyr::select(
    queue_size,
    target_queue_size,
    queue.too.big,
    mean_wait
  ), 
  align = "c"
)

```

There is a column to report the actual average patient waiting time, which is `r round(overall_stats$mean_wait, 2)` weeks, compared to our target of 18 weeks. 

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(mean_wait), 
  align = "c"
)

```

These two columns re-state the coefficients of variance for use in reporting.

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(
    cv_arrival,
    cv_removal
  ), 
  align = "c"
)
```

The next two columns tell us about the required capacity.  Only one will contain data.

1. If the queue is not too large, "target.capacity" will report the capacity required to maintain the queue at it's target waiting time performance.
2. If the queue is too large, "relief.capacity" will report the capacity required to bring the queue to a maintainable size within 26 weeks (6 months).  

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(target.capacity, relief.capacity), 
  align = "c"
)
```

The final column reports the waiting list "pressure".  This will be useful later when comparing waiting lists of differing sizes, with differing targets.  It allows waiting list pressures to be compared because the waiting list with the largest number of patients waiting is not always the list with the largest problem meeting it's target.  

```{r, echo=FALSE}
knitr::kable(
  overall_stats |> dplyr::select(pressure), 
  align = "c"
)
```