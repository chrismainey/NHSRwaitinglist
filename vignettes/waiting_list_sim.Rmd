---
title: "Simulating waiting lists"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulating waiting lists}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(NHSRwaitinglist)
```

# Introduction
When working with waiting lists, we may start with trying to understand current burdens, demand, capacity, load etc.  If we have a planning dimension to our work, we may also want to as 'what if....' or 'how long until...' questions about our waiting list.  Simulation, based on the properties of our waiting lists (or assumptions about how they will change) allow us to ask these questions and test out hypotheses.

The following vignette acts as an example, where we are are modelling a waiting list for a given medical speciality, which might have the flow: GP referral to outpatients, to surgery, using the common NHS waiting time standard of 18 weeks. 

We will imagine three scenarios:
1. where we need to bring a waiting list down into control
1. where our waiting list can afford to grow (e.g. we want to contain capacity, such as reducing independent sector activity)
1. how our list will change with predicted population/referral growth


__Please remember that the examples here are simulations.  They will vary due to change each time they are run, and that is their strength.  Do no expect to get exactly the same result when repeating; expect to get the same average results.__

# Set-up

We will imagine a surgical speciality where, at the beginning of financial year 2023/24. The NHS standard for this waiting list is to have 92% of patients should be  seen and treated by 18 weeks. 

Using the `NHSRwaitinglist` package, we can calculate a few important statistics:

```{r overview}
# What is the quantile value for target waiting list, based on 92% of exponential distribution
qt92 <- qexp(0.92)

# Target mean wait for 18 weeks
target_mean_wait <- calc_target_mean_wait(18,qt92)
target_mean_wait
```
This makes our target average wait `r target_mean_wait`, and this average is regardless of demand/capacity queue size.  The average wait must be this value, or less to meet 92% at 18 weeks.



# 1. Bringing down a waiting list

For our first scenario, let's assume the service received 100 weekly referrals and 80 weekly capacity.  The service was already running with a waiting list of 840.  There are few ways to set this up, including supplying a real waiting list, we can simulate/generate it using the properties of the list, or we can manually dump a load of open pathways into the start of the sim.  

We describe this balance between demand and capacity as the 'Load', which is the ratio between demand and capacity: 100/80= 1.25.  If the Load is greater than 1, then the waiting list will grow, and if it is less than 1 the waiting list will reduce.

Below we simulate one based on knowing the 840 on this list, and 20 more referrals than removals per week (difference in demand and capacity) adds 20 to the waiting list each week.  If we divide the 840 on the waiting list by 20, we get 42 weeks.  We need to run the simulation for 42 weeks (with the stated demand and capacity to generate a waiting list of 840). ___Remember that this is simulation, so it is stochastic.  Any two runs will not be identical, but will lead to 840 on list on average.___

```{r sim_wl_setup}
end_date <- as.Date("2023-03-31")

# WL is 200, simulation is weekly, and capacity / demand difference is 20, 20 added to WL each week
# Therefore 420/20 = 21, 21 week difference for sim start and end date. 7 x 21 = 147 days.
# We take 1 day away too, to discount the end_date

start_date<- end_date - (((840/20) * 7)-1)

current_wl <- wl_simulator(start_date = start_date,
                           end_date = end_date,
                           demand = 100,
                           capacity = 80)

current_wl[is.na(current_wl$Removal),]

tail(wl_queue_size(current_wl))
```


Below, we manually dump 840 open pathways into the sim the day before our start.
```{r dump_wl_setup}
current_wl <- data.frame(Referral = rep(as.Date("2023-03-31"), 840) 
                         , Removal = rep(as.Date(NA), 840)
    )

tail(wl_queue_size(current_wl))
```

## What is the target for this service?

If we are governing our resources well, we want to allow a sustainable queue as this allows people to be flexibly scheduled whilst still meeting our targets.  All capacity comes at a cost to the system, so we are seeking a balance between demand and capacity with a sustainable waiting list.

So our question is: what is the sustainable queue size for delivering 92% at 18 weeks, given 100 weekly demand.

```{r}
target_queue <- calc_target_queue_size(demand = 100, target_wait = 18, factor = qt92)
targe_queue
```

We have a target queue size of `r target_queue`, and currently running a waiting list in excess of this, and load is >1, so the list will keep growing, without intervention, and average wait times will get longer.

## Options for management

There are two ways to bring a waiting list like this down:
1. Raise the capacity ("more flowing out")
2. Reduce the demand ("fewer flowing in")

### Raising capacity

Let's imagine we are able to put an additional clinic in place that offers 25 more slots per week, taking our waiting list pressure down. We need to remember to include our waiting list into the simulation function, so it does not start from zero.  We will run the simulation for a two year period then plot the waiting list.

```{r sim_raise_capacity}
raised_capacity_wl <- 
  wl_simulator(start_date = as.Date("2023-04-01"),
               end_date = as.Date("2024-03-31"),
               demand = 100,
               capacity = 105,
               waiting_list = current_wl)

raised_capacity_queue <- wl_queue_size(raised_capacity_wl)

tail(raised_capacity_queue)
```

To visualise this, we will plot the queue against time, marking the target queue size.

```{r plot_raise_capacity, message=FALSE, warning=FALSE}
library(ggplot2)

ggplot(raise_capacity_queue, aes(y=queue_size, x=dates)) +
  geom_line() +
  geom_hline(yintercept = target_queue, colour = "red")+
  annotate("text", label= "Target queue size", x = as.Date("2024-03-31")
           , y = target_queue, vjust=1, hjust = 1.2, colour = "red")+
  labs(y="Queue Size", x= "Date", title = "Simulated waiting list after raising capacity")+
  theme_minimal()
  
```
The simulation above suggests that, maintaining the extra clinic until the end of the year (31st December), would return the waiting list to just below the sustainable target.